<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="alternate" type="application/rss+xml" title="小生境" href="/feed.xml">
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">小生境</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Thinking in Design Patterns in Python</h1>
    <p class="post-meta">
      <time datetime="2018-05-20T00:00:00+08:00" itemprop="datePublished">
        
        2018-05-20
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <blockquote>
  <p>WARNING: 这篇日志的代码基本都不可运行。</p>
</blockquote>

<p>我想写一个 NLP 训练器的框架，输入语料，输出模型。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TrainingJob</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_config</span><span class="p">,</span> <span class="n">output_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_config</span> <span class="o">=</span> <span class="n">input_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_config</span> <span class="o">=</span> <span class="n">output_config</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">corpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_corpus</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">download_corpus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># do things</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corpus</span><span class="p">):</span>
        <span class="c"># do things</span>

    <span class="k">def</span> <span class="nf">upload_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="c"># do things</span>


<span class="n">input_config</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="n">output_config</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="n">training_job</span> <span class="o">=</span> <span class="n">TrainingJob</span><span class="p">(</span><span class="n">input_config</span><span class="p">,</span> <span class="n">output_config</span><span class="p">)</span>
<span class="n">training_job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<p>大致这样吧，再简化就看不下去了。
应该还是比较清晰明了的，就是输入配置、下载语料、训练模型、上传模型，四个步骤。</p>

<p>但是很快我们发现我们有各种奇怪的训练器，大家的训练算法千奇百怪，需要实现不同的 <code class="highlighter-rouge">train</code> 方法，很自然的，我把 <code class="highlighter-rouge">train</code> 定义为抽象方法，由子类去实现：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TrainingJob</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corpus</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RockTrainingJob</span><span class="p">(</span><span class="n">TrainingJob</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corpus</span><span class="p">):</span>
        <span class="c"># do rock things</span>


<span class="k">class</span> <span class="nc">BluesTrainingJob</span><span class="p">(</span><span class="n">TrainingJob</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corpus</span><span class="p">):</span>
        <span class="c"># do blues things</span>


<span class="n">input_config</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="n">output_config</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="n">rock_training_job</span> <span class="o">=</span> <span class="n">RockTrainingJob</span><span class="p">(</span><span class="n">input_config</span><span class="p">,</span> <span class="n">output_config</span><span class="p">)</span>
<span class="n">rock_training_job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<p>好的，这么一个幼齿的实现已经是 <code class="highlighter-rouge">Template Method</code> (GoF P306) 了。
<code class="highlighter-rouge">Template Method</code> 的目的是 <code class="highlighter-rouge">Define the skeleton of an algorithm in an operation, deferring somesteps to subclasses</code>，我们的场景应该是完美切合模式的。</p>

<p><img src="https://raw.githubusercontent.com/jschwinger23/jschwinger23.github.io/master/_posts/Template%20Method.png" alt="Template Method" /></p>

<hr />

<p>Let’s think more.</p>

<p>考虑给这个框架加一个 entrypoint 能够直接从命令行调用，大概长这样：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>training-job -k rock -i '...' -o '...'
</code></pre></div></div>

<p>然后这个命令行做的事情是使用 <code class="highlighter-rouge">RockTrainingJob</code> 传入 <code class="highlighter-rouge">-i</code> 参数作为 <code class="highlighter-rouge">input_config</code>、<code class="highlighter-rouge">-o</code> 参数作为 <code class="highlighter-rouge">output_config</code> 进行训练。</p>

<p>这里的重点是如何通过 <code class="highlighter-rouge">-k</code> 指定的参数使用不同的 <code class="highlighter-rouge">TrainingJob</code>。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@click.option</span><span class="p">(</span><span class="s">'-k'</span><span class="p">,</span> <span class="s">'--klass'</span><span class="p">)</span>
<span class="nd">@click.option</span><span class="p">(</span><span class="s">'-i'</span><span class="p">,</span> <span class="s">'--input-config'</span><span class="p">)</span>
<span class="nd">@click.option</span><span class="p">(</span><span class="s">'-o'</span><span class="p">,</span> <span class="s">'--output-config'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">input_config</span><span class="p">,</span> <span class="n">output_config</span><span class="p">):</span>
    <span class="n">training_job_class</span> <span class="o">=</span> <span class="n">get_training_class</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
    <span class="n">training_job</span> <span class="o">=</span> <span class="n">training_job_class</span><span class="p">(</span><span class="n">input_config</span><span class="p">,</span> <span class="n">output_config</span><span class="p">)</span>
    <span class="n">training_job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<p>注意这里是 <code class="highlighter-rouge">get_training_class</code> 其实是动态语言+类作为一等公民 (first class) 的 shortcut，在大部分静态语言中由于无法返回一个 class，因此需要格外强调工厂方法：<code class="highlighter-rouge">we call a factory method because it's responsible for "manufacturing" an object</code> (GoF P122)。</p>

<p>如果 Python 无法返回一个 class 是话，那么实现一个工厂函数是必要是：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TrainingFactory</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_training_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_class</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">training_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">BluesTrainingFactory</span><span class="p">(</span><span class="n">TrainingFactory</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">training_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BluesTrainingJob</span>


<span class="k">class</span> <span class="nc">RockTrainingFactory</span><span class="p">(</span><span class="n">TrainingFactory</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">training_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RockTrainingJob</span>


<span class="n">training_factory</span> <span class="o">=</span> <span class="n">get_training_factory</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
<span class="n">training_job</span> <span class="o">=</span> <span class="n">training_factory</span><span class="o">.</span><span class="n">get_training_job</span><span class="p">(</span><span class="n">input_config</span><span class="p">,</span> <span class="n">output_config</span><span class="p">)</span>
<span class="n">training_job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<p>你看 <code class="highlighter-rouge">Factory Method</code> (GoF P121) 里令人讨厌的 <code class="highlighter-rouge">Creator</code> 抽象类和具体类就这样出现了。
<img src="https://raw.githubusercontent.com/jschwinger23/jschwinger23.github.io/master/_posts/Factory%20Method.png" alt="Factory Method" />
<code class="highlighter-rouge">TrainingFactory</code> 就是 <code class="highlighter-rouge">Creator</code>，<code class="highlighter-rouge">BluesTrainingJob</code> 和 <code class="highlighter-rouge">RockTrainingJob</code> 是 <code class="highlighter-rouge">ConcreteCreator</code>，<code class="highlighter-rouge">get_training_job</code> 是 <code class="highlighter-rouge">factory method</code>。</p>

<p>这里的实现展示了 GoF 中的 Implementation Issues 3 中描述的 Smalltalk：<code class="highlighter-rouge">Smalltalk programs often use a method that returns the class of the object to be instantiated</code>，这里让 Python 照葫芦实现了一下。</p>

<p><code class="highlighter-rouge">get_training_factory</code> 其实对应的是 GoF Implementation Issues 2 中的 <code class="highlighter-rouge">Parameterized factory methods</code>。至于 <code class="highlighter-rouge">get_training_class</code> 应该如何实现，手动 register 是比较好的，虽然你用 <code class="highlighter-rouge">locals()</code> 也没问题。</p>

<p>在 <code class="highlighter-rouge">Parameterized factory methods</code> 的实现里有个陷阱，考虑如下的实现：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TrainingJob</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">klass</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">concrete_class</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">concrete_class</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="n">klass</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">concrete_class</span><span class="o">.</span><span class="n">__new__</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nb">ValueError</span>


<span class="k">class</span> <span class="nc">RockTrainingJob</span><span class="p">(</span><span class="n">TrainingJob</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">BluesTrainingJob</span><span class="p">(</span><span class="n">TrainingJob</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div></div>

<p>在这个实现里，我们把 <code class="highlighter-rouge">get_training_job</code> 函数做的事实现到了 <code class="highlighter-rouge">TrainingJob.__new__</code> 里，乍一看我们因此获得了能力可以通过 <code class="highlighter-rouge">__subclasses__</code> 特殊方法去搜索具体类，但是有几个问题：</p>

<ol>
  <li><code class="highlighter-rouge">__new__</code> 被递归调用啦，简直惨不忍睹。</li>
  <li><code class="highlighter-rouge">__new__</code> 返回是对象不是 <code class="highlighter-rouge">cls</code> 的实例就不会调用 <code class="highlighter-rouge">__init__</code> 方法</li>
  <li><code class="highlighter-rouge">__new__</code> 的设计目的是订制不可变对象的创建，把 <code class="highlighter-rouge">__new__</code> 作为工厂方法是滥用</li>
</ol>

<p>所以我们发现在 Python 中实现 <code class="highlighter-rouge">Factory Method</code> 还是简单清爽地 <code class="highlighter-rouge">get_training_class</code> 就好了，非常干净。</p>

<hr />

<p>Let’s think more.</p>

<p>现在我们把 <code class="highlighter-rouge">TrainingJob</code> 这个仓库整体作为一个 training-framework-lib，然后分别实现 rock-training-lib 和 blues-training-lib。</p>

<p>让我说得更具体一点。</p>

<p>training-framework-lib 里实现了 <code class="highlighter-rouge">TrainingJob</code> 抽象基类和 <code class="highlighter-rouge">training-lib</code> CLI；通过在此基础上实现 rock-training-lib，最后通过 <code class="highlighter-rouge">pip install</code> 的方式安装 rock-training-lib、再直接调用 <code class="highlighter-rouge">training-lib</code> CLI 使用 rock-training-lib 中订制的算法。</p>

<p>如果你没意识到这件事情和之前有什么重大不同的话，我提醒一下，之前的 <code class="highlighter-rouge">Template Method</code> 和 <code class="highlighter-rouge">Factory Method</code> 模式，最终我们都是实例化了一个特定的子类、调用子类的 <code class="highlighter-rouge">run</code>、从而使用子类特定实现的方法去做事；但是现在我们是要求实例化父类、调用父类的 <code class="highlighter-rouge">run</code>、却依然使用子类的特定实现。</p>

<p>好的，我们进入到控制反转的领域了。</p>

<p>控制反转是一个伟大的概念，几乎所有的框架都离不开控制反转。Django 到 MVC 到简单的 <code class="highlighter-rouge">conf.settings</code> 里无处不在体现控制反转。</p>

<p>控制反转不仅是代码微观层的重要设计模式，同时也是宏观层的重要方法论。在 DDD 中无处不强调的依赖倒置原则“高层次的模块不应该依赖于低层次的模块，他们都应该依赖于抽象；抽象不应该依赖于具体实现，具体实现应该依赖于抽象”，其思想都是通过控制反转的方式为高层模块提供底层服务。</p>

<p>在这里我们使用控制反转最精炼的实现：依赖注入。</p>

<p>按照 Martin Fowler 那篇首次提出 DI 概念的文章中 (<code class="highlighter-rouge">Inversion of Control Containers and the Dependency Injection pattern</code>)，我们使用 Constructor Injection.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Trainer</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corpus</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">TrainingJob</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">init_instance</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_instance</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_instance</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">:</span> <span class="n">Trainer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">trainer</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_config</span><span class="p">,</span> <span class="n">output_config</span><span class="p">):</span>
        <span class="n">corpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_corpus</span><span class="p">(</span><span class="n">input_config</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="o">...</span>
</code></pre></div></div>

<p>在框架级别上，我们抽象出 <code class="highlighter-rouge">Trainer</code> 抽象基类，并且要求实例化 <code class="highlighter-rouge">TrainingJob</code> 的时候传入 trainer 具体类的实例。</p>

<p>然后在子类的仓库中我们需要在模块初始化之际就使用特定实现的 <code class="highlighter-rouge">RockTrainer</code> 去实例化 <code class="highlighter-rouge">TrainingJob</code>。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RockTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corpus</span><span class="p">):</span>
        <span class="c"># rock</span>


<span class="n">TrainingJob</span><span class="o">.</span><span class="n">init_instance</span><span class="p">(</span><span class="n">RockTrainer</span><span class="p">())</span>
</code></pre></div></div>

<p>这样在稍后调用框架里的 CLI 时，直接调用 <code class="highlighter-rouge">get_instance</code> 方法就能在父类中使用子类订制的 <code class="highlighter-rouge">RockTrainer</code> 了。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="n">training_job</span> <span class="o">=</span> <span class="n">TrainingJob</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
    <span class="n">training_job</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div></div>

<p>稍微熟悉 GoF 的同学都会注意到，上面的依赖注入，感觉和 <code class="highlighter-rouge">Strategy</code> 好像啊。</p>

<p><code class="highlighter-rouge">Strategy</code> 是做啥的？</p>

<blockquote>
  <p>Define a family of algorithms, encapsulate each one, and make theminterchangeable. Strategy lets the algorithm vary independently fromclients that use it.</p>
</blockquote>

<p><img src="https://raw.githubusercontent.com/jschwinger23/jschwinger23.github.io/master/_posts/Strategy.png" alt="Strategy" /></p>

<p>不错，依赖注入确实很像 Strategy 模式。Strategy 的目的是为了能够更加动态切换内部一个组件的实现，但是这恰好也实现了依赖注入，让我们可以直接从父类调用子类的实现。</p>

<hr />

<p>Let’s think more.</p>

<p>在 Martin Fowler 那篇介绍 DI 的旷世杰作里，还提到了另一个 DI 的方法叫做 Service Locatar，其实也很有趣。</p>

<p>如果你熟悉 <code class="highlighter-rouge">好莱坞风格</code> 的话，你一定不会对此感到陌生。</p>

<p>所谓好莱坞风格，就是 <code class="highlighter-rouge">Dont't call me,I will call you</code>，这里的 call 有打电话和调用的双关。一种典型实现就是，注册，疯狂注册，注册到你怀疑人生。</p>

<p>首先在框架实现 <code class="highlighter-rouge">ServiceLoader</code> 提供注册机制：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ServiceLoader</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>
            <span class="k">return</span> <span class="n">cls</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span>


<span class="n">service_loader</span> <span class="o">=</span> <span class="n">ServiceLoader</span><span class="p">()</span>
</code></pre></div></div>

<p>然后在子类仓库中注册子类：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@service_loader.register</span><span class="p">(</span><span class="s">'trainer'</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RockTrainer</span><span class="p">:</span>
    <span class="o">...</span>
</code></pre></div></div>

<p>最后在框架的 <code class="highlighter-rouge">TrainingJob</code> 基类中使用 ServiceLoader 获取 Trainer 就可以了：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TrainingJob</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="n">service_loader</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'trainer'</span><span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div></div>

<p>但是如果你和我一样对注册嗤之以鼻的话（因为我认为继承就已经是很 explicit 的关系了，有继承就不应该有注册，除非继承太泛化），那么可以使用 <code class="highlighter-rouge">__init_subclass__</code> 或者元类在继承之时做好注册。但是本质思想都是一样的。</p>

<hr />

<p>就这样吧- -
虽然还有很多模式可以说，但是感觉最重要的还是创建型的这几个和控制反转的思想。</p>

<p>表达能力极差，实在做不到娓娓道来庖丁解牛。</p>

<p>说实话就算我有 DI 的思想，我也完全写不出 Martin Fowler 那样深入浅出的文章。</p>

<p>软技能太渣了。。</p>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">小生境</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              jschwinger23
            
            </li>
            
            <li><a href="mailto:greyschwinger@gmail.com">greyschwinger@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jschwinger23"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jschwinger23</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Live to tell
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
